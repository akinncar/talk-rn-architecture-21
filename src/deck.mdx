import { Head, Image, Appear } from "mdx-deck";
import Code from "mdx-code";
import { CodeSurfer } from "mdx-deck-code-surfer";

export { default as theme } from "./theme";

import { Intro } from "./Intro";
import { Cover } from "./Cover";
import { Patreon } from "./Patreon";
import { Thanks } from "./Thanks";

import { Img } from "./Img";

<Head>
  <title>RN Architecture in 2021</title>
</Head>

<Cover />

---

<Intro />

---

## Overview

<ul>
  <Appear>
    <li>How React Native works</li>
    <li>Turbo Modules</li>
    <li>Javascript Interface (JSI)</li>
    <li>Fabric</li>
    <li>Codegen</li>
    <li>Future of React Native</li>
  </Appear>
</ul>

---

## Current Architecture

<Img src="./img/current_architecture_diagram.png" height={500} />

---

## React "Native"

<ul>
  <Appear>
    <li>Native Components</li>
    <li>Native Modules</li>
  </Appear>
</ul>

---

## Native Component

---

<div style={{ fontSize: 26 }}>
  <CodeSurfer
    title="Native Component: Color View"
    code={require("!raw-loader!./ColorViewManager.java")}
    showNumbers={false}
    dark={true}
    lang="java"
    steps={[
      { range: [1, 2], notes: "ColorViewManager.java" },
      { range: [4, 8], notes: "ColorViewManager.java" },
      { range: [10, 14], notes: "ColorViewManager.java" },
      { range: [16, 19], notes: "ColorViewManager.java" },
    ]}
  />
</div>

---

<div style={{ fontSize: 26 }}>
  <CodeSurfer
    title="Native Component: Color View"
    code={require("!raw-loader!./ColorPackage.java")}
    showNumbers={false}
    dark={true}
    lang="java"
    steps={[
      { range: [1, 11], notes: "ColorPackage.java" },
      { range: [7, 10], notes: "ColorPackage.java" },
    ]}
  />
</div>

---

<div style={{ fontSize: 26 }}>
  <CodeSurfer
    title="Native Component: Color View"
    code={require("!raw-loader!./ColorApp.js")}
    showNumbers={false}
    dark={true}
    lang="javascript"
    steps={[
      { range: [1, 3], notes: "App.js" },
      { range: [5, 11], notes: "App.js" },
    ]}
  />
</div>

---

## Native Module

---

<div style={{ fontSize: 26 }}>
  <CodeSurfer
    title="Native Module: Sum"
    code={require("!raw-loader!./SumModule.java")}
    showNumbers={false}
    dark={true}
    lang="java"
    steps={[
      { range: [1, 3], notes: "SumModule.java" },
      { range: [5, 13], notes: "SumModule.java" },
      { range: [15, 18], notes: "SumModule.java" },
    ]}
  />
</div>

---

<div style={{ fontSize: 26 }}>
  <CodeSurfer
    title="Native Module: Sum"
    code={require("!raw-loader!./SumPackage.java")}
    showNumbers={false}
    dark={true}
    lang="java"
    steps={[
      { range: [1, 11], notes: "ColorPackage.java" },
      { range: [2, 7], notes: "ColorPackage.java" },
    ]}
  />
</div>

---

<div style={{ fontSize: 26 }}>
  <CodeSurfer
    title="Native Module: Sum"
    code={require("!raw-loader!./SumApp.js")}
    showNumbers={false}
    dark={true}
    lang="javascript"
    steps={[
      { range: [1, 3], notes: "App.js" },
      { range: [5, 11], notes: "App.js" },
    ]}
  />
</div>

---

## Threads

<Img src="./img/threads_1.png" height={500} />

---

## Threads

<Img src="./img/threads_2.png" height={500} />

---

## Threads

<Img src="./img/threads_3.png" height={500} />

---

## Threads

## <Img src="./img/threads_4.png" height={500} />

---

## Threads

<Img src="./img/threads_5.png" height={500} />

---

## Threads

<Img src="./img/threads_6.png" height={500} />

---

## Problems

<ul>
  <Appear>
    <li>Only Asynchronous</li>
    <li>Serialized</li>
    <li>A lot of Layers</li>
  </Appear>
</ul>

---

## Current ScrollView

<Img src="./img/flatlist_async.gif" height={500} />

---

## Turbo Modules

Is the new generation of React Native Modules. It aims to work with native functions like browsers,
exposing native functions using JSI and improving module performances.

---

## Browser Native Function

<Img src="./img/browser_native_func.png" height={100} />

---

## Javascript Interface (JSI)

JSI is an engine-independent API to interact with Javascript from C++.
It allows to call functions and hold references on these two languages,
without the need for any serialization.

---

<div style={{ fontSize: 26 }}>
  <CodeSurfer
    title="Sum Module Header (Objective-C++)"
    code={require("!raw-loader!./Sum.h")}
    showNumbers={false}
    dark={true}
    lang="objectivec"
    steps={[{ range: [1, 8], notes: "Sum.h" }]}
  />
</div>

---

<div style={{ fontSize: 26 }}>
  <CodeSurfer
    title="Sum Module (Objective-C++)"
    code={require("!raw-loader!./Sum.mm")}
    showNumbers={false}
    dark={true}
    lang="objectivec"
    steps={[
      { range: [1, 29], notes: "Sum.mm" },
      { range: [1, 4], notes: "Sum.mm" },
      { range: [6, 15], notes: "Sum.mm" },
      { range: [17, 24], notes: "Sum.mm" },
      { range: [17, 29], notes: "Sum.mm" },
    ]}
  />
</div>

---

<div style={{ fontSize: 26 }}>
  <CodeSurfer
    title="Sum Module Header (C++)"
    code={require("!raw-loader!./react-native-sum.h")}
    showNumbers={false}
    dark={true}
    lang="cpp"
    steps={[{ range: [1, 4], notes: "react-native-sum.h" }]}
  />
</div>

---

<div style={{ fontSize: 26 }}>
  <CodeSurfer
    title="Sum Module (C++)"
    code={require("!raw-loader!./react-native-sum.cpp")}
    showNumbers={false}
    dark={true}
    lang="cpp"
    steps={[
      { range: [1, 28], notes: "react-native-sum.cpp" },
      { range: [1, 4], notes: "react-native-sum.cpp" },
      { range: [6, 28], notes: "react-native-sum.cpp" },
      { range: [8, 8], notes: "react-native-sum.cpp" },
      { range: [9, 9], notes: "react-native-sum.cpp" },
      { range: [10, 10], notes: "react-native-sum.cpp" },
      { range: [11, 20], notes: "react-native-sum.cpp" },
      { range: [22, 23], notes: "react-native-sum.cpp" },
      { range: [27, 27], notes: "react-native-sum.cpp" },
    ]}
  />
</div>

---

<div style={{ fontSize: 26 }}>
  <CodeSurfer
    title="Sum Module (Javascript)"
    code={require("!raw-loader!./SumAppCxx.js")}
    showNumbers={false}
    dark={true}
    lang="javascript"
    steps={[{ range: [1, 7], notes: "App.js" }]}
  />
</div>

---

## Libraries implemented using JSI

- [react-native-reanimated] (https://github.com/software-mansion/react-native-reanimated)
- [react-native-vision-camera] (https://github.com/mrousavy/react-native-vision-camera)
- [react-native-mmkv] (https://github.com/mrousavy/react-native-mmkv)
- [react-native-quick-sqlite] (https://github.com/ospfranco/react-native-quick-sqlite)

---

## Fabric

Is the new React Native renderer. With Fabric, the UI operations are exposed to
Javascript with JSI. This new UI can create and update native components
passing information without using the bridge.

---

## Current Architecture

<Img src="./img/threads_6.png" height={500} />

---

## New Architecture

<Img src="./img/new_arch.png" height={500} />

---

## New Architecture + Codegen

<Img src="./img/new_arch_codegen.png" height={500} />

---

## Codegen (react-native-codegen)

Automation to compatibility JS and Native code. It's a generator that will define
your classes and functions in C++ base on types with Typescript and Flow,
to avoid data validation every time.

---

## What should I do?

<ul>
  <Appear>
    <li>Nothing (Your app will still work)</li>
    <li>Update your app with new RN versions</li>
    <li>Learn how to code with this new features</li>
  </Appear>
</ul>

---

## What's next?

<ul>
  <Appear>
    <li>All new architecture for the community</li>
    <li>More documentation</li>
    <li>RN repository health</li>
    <li>RN better for more platforms</li>
  </Appear>
</ul>

---

## References

- [The New React Native Architecture Explained] (https://formidable.com/blog/2019/react-codegen-part-1/)
- [David Vacca - The state of React Native] (https://youtu.be/FqMTXagEvHo?list=PLZ3MwD-soTTEOWXU2I8Y8C3AfqvJdn3M_)
- [Parashuram N - React Native's New Architecture] (https://youtu.be/UcqRXTriUVI)
- [Emily Janzer - The New React Native] (https://youtu.be/52El0EUI6D0)
- [React-native JSI module] (https://ospfranco.com/post/2021/02/24/how-to-create-a-javascript-jsi-module/)
- [React Native JSI: Part 1 - Getting Started](https://blog.notesnook.com/getting-started-react-native-jsi/)
- [Bringing the Fabric renderer to the “Facebook” app] (https://www.youtube.com/watch?v=xKOkILSLs0Q&t=3985s)
- [React Native in H2] (https://reactnative.dev/blog/2021/08/19/h2-2021)

---

<Patreon />

---

<Thanks />
